var t=function(e,n){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])},t(e,n)};function e(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function i(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(i.prototype=n.prototype,new i)}function n(t,e){var n="function"==typeof Symbol&&t[Symbol.iterator];if(!n)return t;var i,r,o=n.call(t),s=[];try{for(;(void 0===e||e-- >0)&&!(i=o.next()).done;)s.push(i.value)}catch(t){r={error:t}}finally{try{i&&!i.done&&(n=o.return)&&n.call(o)}finally{if(r)throw r.error}}return s}function i(t,e){return Object.defineProperty?Object.defineProperty(t,"raw",{value:e}):t.raw=e,t}"function"==typeof SuppressedError&&SuppressedError;const r=window[Symbol.for("typora-plugin-core@v2")],o=r.app,s=r.Component,a=r.Events;r.Modal,r.Notice;const u=r.I18n,l=r.PluginSettings,c=r.Plugin,g=r.SettingTab;r.SettingItem,r.PostProcessor,r.HtmlPostProcessor,r.CodeblockPostProcessor;const p=r.View;r.EditorSuggest;const d=r.TextSuggest,h=r.WorkspaceRibbon,f=r.Sidebar;r.fs,r.path;const y=r.debounce;r.format;const v=r.html;r.until,r.decorate;var S=function(t){function n(){var e=null!==t&&t.apply(this,arguments)||this;return e._store={},e}return e(n,t),n.prototype.has=function(t){return this._store[t]},n.prototype.add=function(t){return this._store[t]=!0,this.emit("tag:change"),this},n.prototype.bulkAdd=function(t){var e=this;return t.forEach((function(t){return e._store[t]=!0})),this.emit("tag:change"),this},n.prototype.delete=function(t){return delete this._store[t],this.emit("tag:change"),this},n.prototype.toArray=function(){return Object.keys(this._store)},n}(a),m=function(t){function n(e){var n=t.call(this)||this;return n.plugin=e,n}return e(n,t),n.prototype.onload=function(){var t=this;this.plugin.registerMarkdownPreProcessor({when:"preload",type:"mdtext",process:function(e){return e.replace(/(^|\s)(#[^\u2000-\u206F\u2E00-\u2E7F'!"#$%&()*+,.:;<=>?@^`{|}~\[\]\\\s]+)/g,(function(e,n,i){return t.plugin.store.add(i),"".concat(n,'<i alt="tag">').concat(i,"</i>")}))}}),this.plugin.registerMarkdownPreProcessor({when:"presave",type:"mdtext",process:function(t){return t.replace(/<i alt="tag">(#[^\u2000-\u206F\u2E00-\u2E7F'!"#$%&()*+,.:;<=>?@^`{|}~\[\]\\\s]+)<\/i>/g,"$1")}})},n}(s);const b=window.editor,w=window.isInputComponent;var T,E,k=function(t){function i(e){var n=t.call(this)||this;return n.plugin=e,n}return e(i,t),i.prototype.onload=function(){var t=this;this.plugin.registerCommand({id:"toggle-style",title:this.plugin.i18n.t.toggleTag,scope:"editor",hotkey:"Alt+Ctrl+T",callback:function(){return t.toggleTagStyle()}})},i.prototype.toggleTagStyle=function(){var t,e,i,r,o,s,a,u,l;if(!w(document.activeElement)){var c=null!==(r=null===(i=null===(e=null===(t=document.getSelection())||void 0===t?void 0:t.anchorNode)||void 0===e?void 0:e.parentElement)||void 0===i?void 0:i.parentElement)&&void 0!==r?r:null;if(this.isTagEl(c)||this.isTagEl(c.children[1])){b.selection.selectPhrase();var g=n(null!==(a=(p=null!==(s=null===(o=document.getSelection())||void 0===o?void 0:o.toString())&&void 0!==s?s:"").match(/<i alt="tag">#([^<]+)<\/i>/))&&void 0!==a?a:[],2)[1];b.UserOp.pasteHandler(b,g,!1)}else{b.selection.getRangy().collapsed&&b.selection.selectWord();var p,d=((p=null!==(l=null===(u=document.getSelection())||void 0===u?void 0:u.toString())&&void 0!==l?l:"").startsWith("#")?"":"#")+p,h='<i alt="tag">'.concat(d,"</i>");this.plugin.store.add(d),b.UserOp.pasteHandler(b,h,!0)}}},i.prototype.isTagEl=function(t){return t&&"I"===t.tagName&&"tag"===t.getAttribute("alt")},i}(s),P=function(t){function r(e,n){var i=t.call(this)||this;return i.plugin=e,i.debouncedRenderQueriedTags=y((function(){return i.renderQueriedTags()}),500),n.register(e.store.on("tag:change",i.debouncedRenderQueriedTags)),i}return e(r,t),r.prototype.onload=function(){var t=this;this.containerEl=$('<div id="typ-tag-panel" style="display: none;"></div>').append($('<div class="ty-sidebar-search-panel"></div>').append(this.inputEl=$('<input placeholder="Search">').on("input",this.debouncedRenderQueriedTags).get(0)),this.resultEl=$('<div class="typ-tag-results">').on("click",(function(e){var n=e.target;if(n.closest("i")){var i=n.closest(".typ-tag-item").innerText;n.classList.contains("fa-search")?o.features.globalSearch.openGlobalSearch(i):(t.plugin.store.delete(i),t.debouncedRenderQueriedTags())}})).get(0)).get(0)},r.prototype.onunload=function(){this.containerEl.remove()},r.prototype.show=function(){this.renderQueriedTags(),t.prototype.show.call(this)},r.prototype.renderQueriedTags=function(){var t=this.inputEl.value.trim();if(""===t){var e=this.plugin.store.toArray().sort();this.renderTags(e)}else{var n=this.plugin.store.toArray().filter((function(e){return e.includes(t)})).sort();this.renderTags(n)}},r.prototype.renderTags=function(t){var e;this.resultEl.innerHTML="",(e=this.resultEl).append.apply(e,function(t,e,n){if(n||2===arguments.length)for(var i,r=0,o=e.length;r<o;r++)!i&&r in e||(i||(i=Array.prototype.slice.call(e,0,r)),i[r]=e[r]);return t.concat(i||Array.prototype.slice.call(e))}([],n(t.map((function(t){return v(T||(T=i(['<div class="typ-tag-item">','<i class="fa fa-search"></i><i class="fa fa-trash-o"></i></div>'],['<div class="typ-tag-item">','<i class="fa fa-search"></i><i class="fa fa-trash-o"></i></div>'])),t)}))),!1))},r}(p),_=function(t){function n(e,n){var i=t.call(this)||this;return i.app=e,i.plugin=n,n.register(n.settings.onChange("useSuggest",(function(t,e){e?i.load():i.unload()}))),i}return e(n,t),n.prototype.load=function(){this.plugin.settings.get("useSuggest")&&t.prototype.load.call(this)},n.prototype.onload=function(){var t=this.app,e=this.plugin,n=new A(e);this.register(t.workspace.activeEditor.suggestion.register(n)),this.register(e.store.on("tag:change",(function(){return n.loadSuggestions()})));var r=this.app.workspace.getViewByType(f);this.register(this.app.workspace.getViewByType(h).addButton({group:"top",id:"tag",title:e.i18n.t.ribbonTags,className:"typ-tag-button",icon:v(E||(E=i(['<i class="fa fa-tags"></i>'],['<i class="fa fa-tags"></i>']))),onclick:function(){return r.switch(P)}})),this.register(r.addChild(new P(e,this)))},n}(s),A=function(t){function n(e){var n=t.call(this)||this;return n.plugin=e,n.triggerText="#",n.suggestions=[],n.loadSuggestions=y((function(){return n._loadSuggestions()}),1e3),n.loadSuggestions(),n}return e(n,t),n.prototype._loadSuggestions=function(){this.suggestions=this.plugin.store.toArray()},n.prototype.findQuery=function(t){var e,n=null!==(e=t.match(/#([^#\s]*)$/))&&void 0!==e?e:[];return{isMatched:!!n[0],query:n[1]}},n.prototype.getSuggestions=function(e){return t.prototype.getSuggestions.call(this,e).slice(0,50)},n.prototype.beforeApply=function(t){return'<i alt="tag">'.concat(t,"</i>")},n}(d),x=function(t){function n(e){var n=t.call(this)||this;return n.plugin=e,n}return e(n,t),Object.defineProperty(n.prototype,"name",{get:function(){return"Tag"},enumerable:!1,configurable:!0}),n.prototype.show=function(){var e=this.plugin,n=this.plugin.i18n.t;this.addSetting((function(t){t.addName(n.useSuggest.name),t.addDescription(n.useSuggest.desc),t.addCheckbox((function(t){t.checked=e.settings.get("useSuggest"),t.onclick=function(){e.settings.set("useSuggest",t.checked)}}))})),t.prototype.show.call(this)},n.prototype.hide=function(){this.containerEl.innerHTML="",t.prototype.hide.call(this)},n}(g),C={useSuggest:!1,tags:[]},O=function(t){function n(){var e=null!==t&&t.apply(this,arguments)||this;return e.i18n=new u({resources:{en:{toggleTag:"Toggle Focused/Selected Text Tag Style",ribbonTags:"Tags",useSuggest:{name:"Use suggestion",desc:"Input text prefix `#` to trigger tag suggestions."}},"zh-cn":{toggleTag:"切换标签样式",ribbonTags:"标签",useSuggest:{name:"输入建议",desc:"输入触发字符 `#` 触发标签建议。"}}}}),e.store=new S,e}return e(n,t),n.prototype.onload=function(){var t=this;this.registerSettings(new l(this.app,this.manifest,{version:1})),this.settings.setDefault(C),this.store.bulkAdd(this.settings.get("tags")),this.register(this.store.on("tag:change",y((function(){return t.settings.set("tags",t.store.toArray())}),1e3))),this.addChild(new m(this)),this.addChild(new k(this)),this.addChild(new _(this.app,this)),this.registerSettingTab(new x(this))},n}(c);export{O as default};
